@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "_Layout";
}

<div class="container-fluid py-4">
    <div class="row">
        <!-- Statistics Cards -->
        <div class="col-md-12 mb-4">
            <div class="row">
                <div class="col-xl-3 col-sm-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-8">
                                    <div class="numbers">
                                        <p class="text-sm mb-0 text-uppercase font-weight-bold">Total Patients</p>
                                        <h5 class="font-weight-bolder mb-0" id="totalPatients">0</h5>
                                    </div>
                                </div>
                                <div class="col-4 text-end">
                                    <div class="icon icon-shape bg-primary text-white rounded-circle shadow text-center">
                                        <i class="fas fa-users"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-sm-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-8">
                                    <div class="numbers">
                                        <p class="text-sm mb-0 text-uppercase font-weight-bold">Total Doctors</p>
                                        <h5 class="font-weight-bolder mb-0" id="totalDoctors">0</h5>
                                    </div>
                                </div>
                                <div class="col-4 text-end">
                                    <div class="icon icon-shape bg-success text-white rounded-circle shadow text-center">
                                        <i class="fas fa-user-md"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-sm-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-8">
                                    <div class="numbers">
                                        <p class="text-sm mb-0 text-uppercase font-weight-bold">Total Clinics</p>
                                        <h5 class="font-weight-bolder mb-0" id="totalClinics">0</h5>
                                    </div>
                                </div>
                                <div class="col-4 text-end">
                                    <div class="icon icon-shape bg-warning text-white rounded-circle shadow text-center">
                                        <i class="fas fa-hospital"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-sm-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-8">
                                    <div class="numbers">
                                        <p class="text-sm mb-0 text-uppercase font-weight-bold">Today's Appointments</p>
                                        <h5 class="font-weight-bolder mb-0" id="todayAppointments">0</h5>
                                    </div>
                                </div>
                                <div class="col-4 text-end">
                                    <div class="icon icon-shape bg-info text-white rounded-circle shadow text-center">
                                        <i class="fas fa-calendar-check"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#clinicsTab">
                                <i class="fas fa-hospital me-2"></i>Clinics
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#doctorsTab">
                                <i class="fas fa-user-md me-2"></i>Doctors
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#patientsTab">
                                <i class="fas fa-users me-2"></i>Patients
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Clinics Tab -->
                        <div class="tab-pane fade show active" id="clinicsTab">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0">Manage Clinics</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClinicModal">
                                    <i class="fas fa-plus me-2"></i>Add New Clinic
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table align-middle">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Address</th>
                                            <th>Phone</th>
                                            <th>Doctors</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clinicsList">
                                        <!-- Clinics will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Doctors Tab -->
                        <div class="tab-pane fade" id="doctorsTab">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0">Manage Doctors</h5>
                                <div>
                                    <button class="btn btn-outline-primary me-2" id="exportDoctorsBtn">
                                        <i class="fas fa-download me-2"></i>Export
                                    </button>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDoctorModal">
                                        <i class="fas fa-plus me-2"></i>Add New Doctor
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table align-middle">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>License Number</th>
                                            <th>Clinic</th>
                                            <th>Email</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="doctorsList">
                                        <!-- Doctors will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Patients Tab -->
                        <div class="tab-pane fade" id="patientsTab">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0">Manage Patients</h5>
                                <div>
                                    <button class="btn btn-outline-primary me-2" id="exportPatientsBtn">
                                        <i class="fas fa-download me-2"></i>Export
                                    </button>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPatientModal">
                                        <i class="fas fa-plus me-2"></i>Add New Patient
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table align-middle">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>TC Identity Number</th>
                                            <th>Email</th>
                                            <th>Last Visit</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patientsList">
                                        <!-- Patients will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Clinic Modal -->
<div class="modal fade" id="addClinicModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Clinic</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addClinicForm">
                    <div class="mb-3">
                        <label for="clinicName" class="form-label">Clinic Name</label>
                        <input type="text" class="form-control" id="clinicName" required>
                    </div>
                    <div class="mb-3">
                        <label for="clinicAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="clinicAddress" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="clinicPhone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="clinicPhone" required>
                    </div>
                    <div class="mb-3">
                        <label for="clinicEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="clinicEmail" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveClinicBtn">Add Clinic</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Doctor Modal -->
<div class="modal fade" id="addDoctorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Doctor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addDoctorForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="doctorFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="doctorFirstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="doctorLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="doctorLastName" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="doctorEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="doctorEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="doctorLicenseNumber" class="form-label">License Number</label>
                        <input type="text" class="form-control" id="doctorLicenseNumber" required>
                    </div>
                    <div class="mb-3">
                        <label for="doctorClinic" class="form-label">Clinic</label>
                        <select class="form-select" id="doctorClinic" required>
                            <option value="">Select clinic...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDoctorBtn">Add Doctor</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Patient Modal -->
<div class="modal fade" id="addPatientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPatientForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="patientFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="patientFirstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="patientLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="patientLastName" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="patientEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="patientEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="patientTCIdentityNumber" class="form-label">TC Identity Number</label>
                        <input type="text" class="form-control" id="patientTCIdentityNumber" required maxlength="11">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="patientGender" class="form-label">Gender</label>
                            <select class="form-select" id="patientGender" required>
                                <option value="">Select gender...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="patientDateOfBirth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="patientDateOfBirth" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePatientBtn">Add Patient</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadStatistics();
            loadClinics();
            loadDoctors();
            loadPatients();

            // Event handlers
            $('#saveClinicBtn').click(saveClinic);
            $('#saveDoctorBtn').click(saveDoctor);
            $('#savePatientBtn').click(savePatient);
            $('#exportDoctorsBtn').click(exportDoctors);
            $('#exportPatientsBtn').click(exportPatients);

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });
        });

        function loadStatistics() {
            $.get('/api/Admin/statistics', function(stats) {
                $('#totalPatients').text(stats.totalPatients);
                $('#totalDoctors').text(stats.totalDoctors);
                $('#totalClinics').text(stats.totalClinics);
                $('#todayAppointments').text(stats.todayAppointments);
            });
        }

        function loadClinics() {
            $.get('/api/Clinics', function(clinics) {
                $('#clinicsList').empty();
                clinics.forEach(clinic => {
                    $('#clinicsList').append(createClinicRow(clinic));
                });

                // Populate clinic select in add doctor form
                $('#doctorClinic').empty().append('<option value="">Select clinic...</option>');
                clinics.forEach(clinic => {
                    $('#doctorClinic').append(`<option value="${clinic.clinicId}">${clinic.name}</option>`);
                });
            });
        }

        function loadDoctors() {
            $.get('/api/Doctors', function(doctors) {
                $('#doctorsList').empty();
                doctors.forEach(doctor => {
                    $('#doctorsList').append(createDoctorRow(doctor));
                });
            });
        }

        function loadPatients() {
            $.get('/api/Patients', function(patients) {
                $('#patientsList').empty();
                patients.forEach(patient => {
                    $('#patientsList').append(createPatientRow(patient));
                });
            });
        }

        function saveClinic() {
            const clinicData = {
                name: $('#clinicName').val(),
                address: $('#clinicAddress').val(),
                phone: $('#clinicPhone').val(),
                email: $('#clinicEmail').val()
            };

            $.ajax({
                url: '/api/Clinics',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(clinicData),
                success: function() {
                    $('#addClinicModal').modal('hide');
                    loadClinics();
                    loadStatistics();
                    alert('Clinic added successfully!');
                },
                error: function(xhr) {
                    alert('Failed to add clinic: ' + xhr.responseText);
                }
            });
        }

        function saveDoctor() {
            const doctorData = {
                firstName: $('#doctorFirstName').val(),
                lastName: $('#doctorLastName').val(),
                email: $('#doctorEmail').val(),
                licenseNumber: $('#doctorLicenseNumber').val(),
                clinicId: $('#doctorClinic').val()
            };

            $.ajax({
                url: '/api/Doctors',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(doctorData),
                success: function() {
                    $('#addDoctorModal').modal('hide');
                    loadDoctors();
                    loadStatistics();
                    alert('Doctor added successfully!');
                },
                error: function(xhr) {
                    alert('Failed to add doctor: ' + xhr.responseText);
                }
            });
        }

        function savePatient() {
            const patientData = {
                firstName: $('#patientFirstName').val(),
                lastName: $('#patientLastName').val(),
                email: $('#patientEmail').val(),
                tcIdentityNumber: $('#patientTCIdentityNumber').val(),
                gender: $('#patientGender').val(),
                dateOfBirth: $('#patientDateOfBirth').val()
            };

            $.ajax({
                url: '/api/Patients',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(patientData),
                success: function() {
                    $('#addPatientModal').modal('hide');
                    loadPatients();
                    loadStatistics();
                    alert('Patient added successfully!');
                },
                error: function(xhr) {
                    alert('Failed to add patient: ' + xhr.responseText);
                }
            });
        }

        function createClinicRow(clinic) {
            return `
                <tr>
                    <td>${clinic.name}</td>
                    <td>${clinic.address}</td>
                    <td>${clinic.phone}</td>
                    <td>${clinic.doctorsCount}</td>
                    <td><span class="badge bg-${clinic.active ? 'success' : 'danger'}">${clinic.active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editClinic(${clinic.clinicId})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteClinic(${clinic.clinicId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        function createDoctorRow(doctor) {
            return `
                <tr>
                    <td>${doctor.firstName} ${doctor.lastName}</td>
                    <td>${doctor.licenseNumber}</td>
                    <td>${doctor.clinicName}</td>
                    <td>${doctor.email}</td>
                    <td><span class="badge bg-${doctor.active ? 'success' : 'danger'}">${doctor.active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editDoctor(${doctor.doctorId})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDoctor(${doctor.doctorId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        function createPatientRow(patient) {
            return `
                <tr>
                    <td>${patient.firstName} ${patient.lastName}</td>
                    <td>${patient.tcIdentityNumber}</td>
                    <td>${patient.email}</td>
                    <td>${patient.lastVisit ? new Date(patient.lastVisit).toLocaleDateString() : 'Never'}</td>
                    <td><span class="badge bg-${patient.active ? 'success' : 'danger'}">${patient.active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editPatient(${patient.patientId})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePatient(${patient.patientId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        function exportDoctors() {
            window.location.href = '/api/Admin/export/doctors';
        }

        function exportPatients() {
            window.location.href = '/api/Admin/export/patients';
        }

        function editClinic(clinicId) {
            // Implement clinic edit functionality
        }

        function deleteClinic(clinicId) {
            if (!confirm('Are you sure you want to delete this clinic?')) return;

            $.ajax({
                url: `/api/Clinics/${clinicId}`,
                type: 'DELETE',
                success: function() {
                    loadClinics();
                    loadStatistics();
                    alert('Clinic deleted successfully!');
                },
                error: function(xhr) {
                    alert('Failed to delete clinic: ' + xhr.responseText);
                }
            });
        }

        function editDoctor(doctorId) {
            // Implement doctor edit functionality
        }

        function deleteDoctor(doctorId) {
            if (!confirm('Are you sure you want to delete this doctor?')) return;

            $.ajax({
                url: `/api/Doctors/${doctorId}`,
                type: 'DELETE',
                success: function() {
                    loadDoctors();
                    loadStatistics();
                    alert('Doctor deleted successfully!');
                },
                error: function(xhr) {
                    alert('Failed to delete doctor: ' + xhr.responseText);
                }
            });
        }

        function editPatient(patientId) {
            // Implement patient edit functionality
        }

        function deletePatient(patientId) {
            if (!confirm('Are you sure you want to delete this patient?')) return;

            $.ajax({
                url: `/api/Patients/${patientId}`,
                type: 'DELETE',
                success: function() {
                    loadPatients();
                    loadStatistics();
                    alert('Patient deleted successfully!');
                },
                error: function(xhr) {
                    alert('Failed to delete patient: ' + xhr.responseText);
                }
            });
        }
    </script>
} 